<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Updated: Fixed missing closing div tag -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ImpactLens – RCR Lookup & Article Sharing</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 40px;
      background: #e8f4ff;
      text-align: center;
    }

    .tab-container {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }

    .tab-btn {
      padding: 10px 20px;
      cursor: pointer;
      border: none;
      background: #eee;
      margin: 0 5px;
      font-size: 16px;
      border-radius: 5px 5px 0 0;
    }

    .tab-btn.active {
      background: white;
      font-weight: bold;
      border-bottom: 2px solid white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      max-width: 600px;
      margin: auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 40px;
    }

    input, select {
      padding: 10px;
      width: 90%;
      font-size: 16px;
      margin-bottom: 10px;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      margin-bottom: 20px;
    }

      #searchFilterWrapper {
        display: flex;
        justify-content: space-between;
        gap: 10px; /* spacing between search and filter */
        width: 90%;
        max-width: 1000px;
        margin: 1rem auto;
      }

      #searchInput {
        flex: 1;
        
        padding: 0.5rem 1rem;
        border-radius: 5px;
        border: 1px solid #ccc;
        font-size: 1rem;
         min-width: 0;
      }

      #searchInput::placeholder {
        color: #000000; /* change this to any color you want */
        opacity: 1;  /* some browsers make placeholder semi-transparent by default */
      }

      #filterSpecialty {
        flex: 1; 
        padding: 0.5rem 1rem;
        border-radius: 5px;
        border: 1px solid #ccc;
        font-size: 1rem;
         min-width: 0;
        -webkit-appearance: none; /* remove default style in Chrome/Safari */
        -moz-appearance: none;    /* remove default style in Firefox */
        appearance: none;         /* modern standard */
        padding: 0.5rem 1rem;     /* match the search input */
        text-indent: 0;           /* remove default extra indent */
        text-align: left;         /* align text to left */
      }
      #filterSpecialty {
        background: url('data:image/svg+xml;utf8,<svg fill="gray" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 0.5rem center;
        background-size: 1rem;
      }

    #searchInput:focus {
      border-color: #0419d1ff; /* match your dashboard blue */
      box-shadow: 0 0 0 2px rgba(4, 25, 209, 0.2);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    th {
      background: #eee;
    }

  #articlesTable, #benchmarkTable {
  max-height: 500px; /* adjust height as needed */
  overflow-y: auto;
  display: block; /* necessary for scroll to work */
  border: 1px solid #ccc; /* optional, for visual boundary */
  border-radius: 5px; /* optional */
}

#articlesTable table, #benchmarkTable table {
  width: 100%;
  border-collapse: collapse;
}
  </style>
</head>
<body>

  <!-- Tabs -->
  <div class="tab-container">
    <button class="tab-btn active" data-tab="rcrLookup">RCR Lookup</button>
    <button class="tab-btn" data-tab="articleSharing">Article Sharing</button>
  </div>

  <!-- RCR Lookup -->
  <div id="rcrLookup" class="tab-content active">
    <div class="container">
      <h1>ImpactLens – RCR Lookup</h1>
      <p>Enter a PubMed ID to retrieve the Relative Citation Ratio (RCR).</p>
      <input id="pmid" type="text" placeholder="Enter PMID" />
      <br>
      <button onclick="getRCR()">Get RCR</button>
      <div id="result"></div>
    </div>

<!-- Benchmarking Feature -->
<div class="container">
  <h2>Benchmark Article</h2>

  <!-- Specialty -->
  <label for="benchmarkSpecialty" style="display:block; margin-top:10px;">Specialty:</label>
  <select id="benchmarkSpecialty" style="width:90%; padding:10px; font-size:16px; margin-bottom:10px;">
    <option value="All">All Specialties</option>
    <option value="Orthopaedic Surgery">Orthopaedic Surgery</option>
    <option value="Obstetrics and Gynecology">Obstetrics and Gynecology</option>
    <option value="Neurosurgery">Neurosurgery</option>
    <option value="Cardiothoracic Surgery">Cardiothoracic Surgery</option>
    <option value="Plastic Surgery">Plastic Surgery</option>
    <option value="General Surgery">General Surgery</option>
    <option value="Otolaryngology">Otolaryngology</option>
    <option value="Urology">Urology</option>
    <option value="Colorectal Surgery">Colorectal Surgery</option>
    <option value="Ophthalmology">Ophthalmology</option>
    <option value="Dermatology">Dermatology</option>
    <option value="Oncology">Oncology</option>
    <option value="Psychiatry">Psychiatry</option>
    <option value="Emergency Medicine">Emergency Medicine</option>
    <option value="Pediatrics">Pediatrics</option>
    <option value="Cardiology">Cardiology</option>
    <option value="Family Medicine">Family Medicine</option>
    <option value="Anesthesiology">Anesthesiology</option>
    <option value="Neurology">Neurology</option>
    <option value="Endocrinology">Endocrinology</option>
    <option value="Radiology">Radiology</option>
    <option value="Allergy and Immunology">Allergy and Immunology</option>
    <option value="Nephrology">Nephrology</option>
    <option value="Rheumatology">Rheumatology</option>
  </select>

  <!-- Location -->
  <label for="benchmarkLocation" style="display:block; margin-top:10px;">Location:</label>
  <select id="benchmarkLocation" style="width:90%; padding:10px; font-size:16px; margin-bottom:10px;">
    <option value="All">All Locations</option>
    <option value="Afghanistan">Afghanistan</option>
    <option value="Albania">Albania</option>
    <option value="Antigua and Barbuda">Antigua and Barbuda</option>
    <option value="Argentina">Argentina</option>
    <option value="Aruba">Aruba</option>
    <option value="Australia">Australia</option>
    <option value="Austria">Austria</option>
    <option value="Azerbaijan">Azerbaijan</option>
    <option value="Bahrain">Bahrain</option>
    <option value="Bangladesh">Bangladesh</option>
    <option value="Barbados">Barbados</option>
    <option value="Belarus">Belarus</option>
    <option value="Bhutan">Bhutan</option>
    <option value="Botswana">Botswana</option>
    <option value="Brazil">Brazil</option>
    <option value="Bulgaria">Bulgaria</option>
    <option value="Canada">Canada</option>
    <option value="Cayman Islands">Cayman Islands</option>
    <option value="China">China</option>
    <option value="Colombia">Colombia</option>
    <option value="Costa Rica">Costa Rica</option>
    <option value="Croatia">Croatia</option>
    <option value="Cuba">Cuba</option>
    <option value="Czech Republic">Czech Republic</option>
    <option value="Denmark">Denmark</option>
    <option value="Dominica">Dominica</option>
    <option value="Egypt">Egypt</option>
    <option value="Ethiopia">Ethiopia</option>
    <option value="France">France</option>
    <option value="Georgia">Georgia</option>
    <option value="Germany">Germany</option>
    <option value="Ghana">Ghana</option>
    <option value="Grenada">Grenada</option>
    <option value="Guyana">Guyana</option>
    <option value="Hong Kong">Hong Kong</option>
    <option value="Hungary">Hungary</option>
    <option value="India">India</option>
    <option value="Indonesia">Indonesia</option>
    <option value="Iran">Iran</option>
    <option value="Iraq">Iraq</option>
    <option value="Republic of Ireland">Republic of Ireland</option>
    <option value="Israel">Israel</option>
    <option value="Italy">Italy</option>
    <option value="Japan">Japan</option>
    <option value="Kyrgyzstan">Kyrgyzstan</option>
    <option value="Libya">Libya</option>
    <option value="Lithuania">Lithuania</option>
    <option value="Malawi">Malawi</option>
    <option value="Malaysia">Malaysia</option>
    <option value="Mauritius">Mauritius</option>
    <option value="Taiwan">Taiwan</option>
    <option value="Mexico">Mexico</option>
    <option value="Montenegro">Montenegro</option>
    <option value="Myanmar">Myanmar</option>
    <option value="Namibia">Namibia</option>
    <option value="Nepal">Nepal</option>
    <option value="Netherlands">Netherlands</option>
    <option value="New Zealand">New Zealand</option>
    <option value="Nigeria">Nigeria</option>
    <option value="Pakistan">Pakistan</option>
    <option value="Peru">Peru</option>
    <option value="Philippines">Philippines</option>
    <option value="Poland">Poland</option>
    <option value="Qatar">Qatar</option>
    <option value="Romania">Romania</option>
    <option value="Russia">Russia</option>
    <option value="Rwanda">Rwanda</option>
    <option value="Saint Kitts and Nevis">Saint Kitts and Nevis</option>
    <option value="Serbia">Serbia</option>
    <option value="Singapore">Singapore</option>
    <option value="Slovakia">Slovakia</option>
    <option value="South Korea">South Korea</option>
    <option value="Spain">Spain</option>
    <option value="Sri Lanka">Sri Lanka</option>
    <option value="Sudan">Sudan</option>
    <option value="Sweden">Sweden</option>
    <option value="Syria">Syria</option>
    <option value="Thailand">Thailand</option>
    <option value="Turkey">Turkey</option>
    <option value="Uganda">Uganda</option>
    <option value="Ukraine">Ukraine</option>
    <option value="United Arab Emirates">United Arab Emirates</option>
    <option value="United Kingdom">United Kingdom</option>
    <option value="United States">United States</option>
    <option value="Uzbekistan">Uzbekistan</option>
    <option value="Vietnam">Vietnam</option>
    <option value="Zambia">Zambia</option>
  </select>

  <!-- Article RCR -->
  <label for="benchmarkRCR" style="display:block; margin-top:10px;">Article RCR:</label>
  <input 
    id="benchmarkRCR" 
    type="number" 
    step="0.01" 
    placeholder="Enter article RCR"
    style="width:90%; padding:10px; font-size:16px; margin-bottom:10px; box-sizing:border-box;"
  />

  <!-- Compute Benchmark Button -->
  <button id="computeBenchmark" style="margin-top:10px;">Compute Benchmark</button>
  <div id="benchmarkTable" style="margin-top:10px;"></div>
</div>
  </div>

  <!-- Article Sharing Tab -->
  <div id="articleSharing" class="tab-content">
    <div class="container">
      <h1>Share an Article</h1>
      <form id="articleForm">
        <input id="pmidInput" placeholder="PMID (optional)" /><br>
        <input id="titleInput" placeholder="Title" required /><br>
	<input id="yearInput" type="number" placeholder="Year" /><br>
        <input id="authorsInput" placeholder="Authors (comma separated)" required /><br>
	<input id="specialtyInput" placeholder="Specialty (Focus) ex. Cardiology, Neurology" required /><br>
	<input id="locationInput" placeholder="Location (Country) ex. United States, United Kingdom" required /><br>
        <button type="submit">Submit Article</button>
      </form>
      <div id="searchFilterWrapper">
        <input type="text" id="searchInput" placeholder="Search articles..." />
        <select id="filterSpecialty">
          <option value="All">All Specialties</option>
          <!-- dynamically filled with specialties -->
        </select>
      </div>
      <div id="articlesTable"></div>

    </div>
  </div>

  <script type="module">
    import { db } from './firebaseConfig.js';
    import { collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const articlesCollection = collection(db, "articles");

    // === RCR Lookup ===
    async function getRCR() {
      const pmid = document.getElementById("pmid").value.trim();
      if (!pmid) {
        document.getElementById("result").innerText = "Please enter a PMID.";
        return;
      }
      const url = `/.netlify/functions/getRCR?pmid=${pmid}`;
      try {
        const response = await fetch(url);
        const data = await response.json();
        if (!data.data || data.data.length === 0) {
          document.getElementById("result").innerText = "No data found for this PMID.";
          return;
        }
        const rcr = data.data[0].relative_citation_ratio;
        document.getElementById("result").innerText =
          `RCR: ${rcr !== null ? rcr.toFixed(3) : "Not available"}`;
      } catch (error) {
        document.getElementById("result").innerText = "Error fetching RCR.";
        console.error(error);
      }
    }

    window.getRCR = getRCR; // expose to global for button onclick

    // === Article Sharing ===
    document.getElementById("articleForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const pmid = document.getElementById("pmidInput").value.trim();
      const title = document.getElementById("titleInput").value.trim();
      const year = parseInt(document.getElementById("yearInput").value) || new Date().getFullYear();
      const authors = document.getElementById("authorsInput").value.split(',').map(a => a.trim());
      const specialty = document.getElementById("specialtyInput").value.trim();
      const location = document.getElementById("locationInput").value.trim();

      let rcr = null;
      if (pmid) {
        try {
          const url = `/.netlify/functions/getRCR?pmid=${pmid}`;
          const response = await fetch(url);
          const data = await response.json();
          if (data.data && data.data.length > 0) {
            rcr = data.data[0].relative_citation_ratio;
          }
        } catch(err) {
          console.error("Error fetching RCR for article submission:", err);
        }
      }

       await addDoc(articlesCollection, { pmid, title, authors, specialty, location, rcr, year });
       displayArticles();
       document.getElementById("articleForm").reset();
    });

let allArticles = []; // store all articles

async function displayArticles() {
  const snapshot = await getDocs(articlesCollection);
  allArticles = snapshot.docs.map(doc => doc.data());
  renderArticles(allArticles.slice(0, 10)); // show first 10 initially
}

    function renderArticles(articlesToRender) {
      const tableDiv = document.getElementById("articlesTable");
      let html = `<table>
        <tr>
          <td>PMID</td>
          <th>Title</th>
          <th>Authors</th>
          <th>Specialty</th>
          <th>Location</th>
          <th>RCR</th>
        </tr>`;

      articlesToRender.forEach(a => {
        let pmidHTML = a.pmid 
          ? `<a href="https://pubmed.ncbi.nlm.nih.gov/${a.pmid}/" target="_blank">${a.pmid}</a>` 
          : "";
        html += `<tr class="article-row">
          <td>${pmidHTML}</td>
          <td>${a.title}</td>
          <td>${a.authors.join(', ')}</td>
          <td>${a.specialty}</td>
          <td>${a.location}</td>
          <td>${a.rcr !== null ? a.rcr.toFixed(2) : "N/A"}</td>
        </tr>`;
      });

      html += `</table>`;
      tableDiv.innerHTML = html;
    }

    // === Benchmarking Feature ===
    function computePercentile(sortedArray, value) {
      if (!sortedArray.length) return null;
      let count = sortedArray.filter(v => v <= value).length;
      return (count / sortedArray.length) * 100;
    }

    function median(array) {
      if (!array.length) return null;
      array.sort((a,b)=>a-b);
      const mid = Math.floor(array.length/2);
      return array.length % 2 === 0 ? (array[mid-1]+array[mid])/2 : array[mid];
    }

    function quartiles(array) {
      if (!array.length) return [null, null];
      array.sort((a,b)=>a-b);
      const q1Index = Math.floor((array.length-1)/4);
      const q3Index = Math.floor(3*(array.length-1)/4);
      return [array[q1Index], array[q3Index]];
    }


    document.getElementById("computeBenchmark").addEventListener("click", async () => {
      const specialty = document.getElementById("benchmarkSpecialty").value;
      const location = document.getElementById("benchmarkLocation").value;
      const articleRCR = parseFloat(document.getElementById("benchmarkRCR").value);

      const snapshot = await getDocs(articlesCollection);
      let articles = snapshot.docs.map(doc => doc.data());

      if (specialty !== "All") articles = articles.filter(a => a.specialty === specialty);
      if (location !== "All") articles = articles.filter(a => a.location === location);

      const rcrs = articles.map(a => a.rcr).filter(r => r !== null).sort((a,b)=>a-b);
      const articleCount = rcrs.length;
      const med = median(rcrs)?.toFixed(2) || "Not Found";
      const [q1, q3] = quartiles(rcrs).map(v => v?.toFixed(2) || "Not Found");
      const percentile = articleRCR && rcrs.length ? computePercentile(rcrs, articleRCR).toFixed(0) : "N/A";

      const tableDiv = document.getElementById("benchmarkTable");
      tableDiv.innerHTML = `<table>
        <tr>
          <th>Specialty</th>
          <th>Location</th>
          <th>Article Count</th>
          <th>Median</th>
          <th>1Q</th>
          <th>3Q</th>
          <th>Percentile</th>
        </tr>
        <tr>
          <td>${specialty}</td>
          <td>${location}</td>
          <td>${articleCount}</td>
          <td>${med}</td>
          <td>${q1}</td>
          <td>${q3}</td>
          <td>${percentile}</td>
        </tr>
      </table>`;
    });

  async function populateSpecialtyFilter() {
  const snapshot = await getDocs(articlesCollection);
  const specialtiesSet = new Set();

  snapshot.forEach(doc => {
    const a = doc.data();
    if (a.specialty) specialtiesSet.add(a.specialty);
  });

  const filterSelect = document.getElementById('filterSpecialty');
  
  // Clear existing options except "All"
  filterSelect.innerHTML = '<option value="All">All Specialties</option>';

  // Add specialties dynamically
  [...specialtiesSet].sort().forEach(spec => {
    const option = document.createElement('option');
    option.value = spec;
    option.textContent = spec;
    filterSelect.appendChild(option);
  });
}

    // Load articles initially
    displayArticles();
    populateSpecialtyFilter();

const searchInput = document.getElementById('searchInput');
const filterSelect = document.getElementById('filterSpecialty');

function filterArticles() {
  const query = searchInput.value.toLowerCase();
  const specialty = filterSelect.value;

  const filtered = allArticles.filter(a => {
    const matchesSearch = Object.values(a).some(v => String(v).toLowerCase().includes(query));
    const matchesSpecialty = specialty === 'All' || a.specialty === specialty;
    return matchesSearch && matchesSpecialty;
  });

  renderArticles(filtered); 
}

// Add event listeners
searchInput.addEventListener('input', filterArticles);
filterSelect.addEventListener('change', filterArticles);

    // === Tab switching ===
    const tabs = document.querySelectorAll(".tab-btn");
    const contents = document.querySelectorAll(".tab-content");
    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        contents.forEach(c => c.classList.remove("active"));
        document.getElementById(tab.dataset.tab).classList.add("active");
      });
    });
  </script>
</body>
</html>